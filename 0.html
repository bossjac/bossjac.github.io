<!DOCTYPE html>
<html>
<head>
    <title>YandexMap</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="https://api-maps.yandex.ru/2.1/?lang=en_RU&amp;apikey=70454df0-07f0-4754-bfad-f845f2ecb6aa" type="text/javascript"></script>
    <style type="text/css">
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script type="text/javascript">
        var myMap;

        function init() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, error);
            } else {
                alert("Geolocation is not supported by this browser.");
            }

            function success(position) {
                var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;

                console.log("User location:", latitude, longitude);

                myMap = new ymaps.Map('map', {
                    center: [latitude, longitude],
                    zoom: 17,
                    controls: ['zoomControl', 'typeSelector', 'trafficControl']
                }, {
                    searchControlProvider: 'yandex#search'
                });

                var placemark = new ymaps.Placemark([latitude, longitude], {}, {
                    iconLayout: 'default#image',
                    iconImageHref: 'https://duckduckgo.com/js/mapbox/ddgimages/crosshair.svg',
                    iconImageSize: [32, 32],
                    iconImageOffset: [-16, -16]
                });
                myMap.geoObjects.add(placemark);

                fetchRoads(latitude, longitude);

                // Listen for device motion events to detect shaking
                window.addEventListener('devicemotion', function(event) {
                    var acceleration = event.accelerationIncludingGravity;
                    var accelerationChange = Math.abs(lastAcceleration - acceleration);
                    if (accelerationChange > shakeThreshold) {
                        focusOnCurrentLocation();
                    }
                });

                // Update user's location every 5 seconds
                setInterval(function() {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var newLatitude = position.coords.latitude;
                        var newLongitude = position.coords.longitude;
                        console.log("User location updated:", newLatitude, newLongitude);

                        placemark.geometry.setCoordinates([newLatitude, newLongitude]);
                    });
                }, 5000);
            }

            function error() {
                alert("Unable to retrieve your location. Using default location.");
                myMap = new ymaps.Map('map', {
                    center: [33.5951, -7.6186],
                    zoom: 9,
                    controls: ['zoomControl', 'typeSelector', 'trafficControl']
                }, {
                    searchControlProvider: 'yandex#search'
                });
            }
        }

        function focusOnCurrentLocation() {
            navigator.geolocation.getCurrentPosition(function(position) {
                var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;
                myMap.setCenter([latitude, longitude], 17);
            });
        }

        function fetchRoads(lat, lng) {
            var query = `[out:json];way(around:500, ${lat}, ${lng})[highway];out;`;
            var url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Roads count:", data.elements.length);
                    processRoadData(data);
                })
                .catch(error => {
                    console.error('Error fetching road data:', error);
                });
        }

        function processRoadData(data) {
            data.elements.forEach(element => {
                if (element.type === "way") {
                    var wayId = element.id;
                    fetch(`https://www.openstreetmap.org/api/0.6/way/${wayId}/full`)
                        .then(response => response.text())
                        .then(xmlData => {
                            var parser = new DOMParser();
                            var xmlDoc = parser.parseFromString(xmlData, "text/xml");
                            var nodes = xmlDoc.getElementsByTagName("nd");
                            var nodeRefs = Array.from(nodes).map(nd => nd.getAttribute("ref"));
                            var roadCoordinates = [];
                            nodeRefs.forEach(ref => {
                                var node = xmlDoc.querySelector(`node[id="${ref}"]`);
                                if (node) {
                                    var lat = parseFloat(node.getAttribute("lat"));
                                    var lon = parseFloat(node.getAttribute("lon"));
                                    roadCoordinates.push([lat, lon]);
                                }
                            });
                            drawRoad(roadCoordinates);
                        })
                        .catch(error => {
                            console.error('Error fetching road details:', error);
                        });
                }
            });
        }

        function drawRoad(coordinates) {
            var road = new ymaps.Polyline(
                coordinates,
                {},
                {
                    strokeColor: 'rgb(12, 12, 12)',
                    strokeWidth: 5,
                    strokeOpacity: 0.3
                }
            );
            myMap.geoObjects.add(road);
        }

        var shakeThreshold = 1000; // Adjust this value as needed
        var lastAcceleration = 0;

        ymaps.ready(init);
    </script>
</body>
</html>
